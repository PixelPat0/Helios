{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Orders Pending Shipment</h2>
        <span class="badge bg-primary">{{ orders|length }} Orders</span>
    </div>

    <div class="row mb-3">
        <div class="col-md-4">
            <form class="d-flex" method="GET">
                <input type="hidden" name="status" value="{{ current_filter }}">
                <input type="text" 
                       name="search" 
                       class="form-control me-2" 
                       placeholder="Search orders..."
                       value="{{ search_query }}">
                <button type="submit" class="btn btn-outline-primary">
                    <i class="bi bi-search"></i>
                </button>
            </form>
        </div>
        <div class="col-md-3">
            <select class="form-select" onchange="window.location.href='?status=' + this.value">
                {% if request.resolver_match.url_name == 'not_shipped_dash' %}
                    <option value="active" {% if current_filter == 'active' %}selected{% endif %}>Active Orders</option>
                    <option value="cancelled" {% if current_filter == 'cancelled' %}selected{% endif %}>Cancelled Orders</option>
                    <option value="all" {% if current_filter == 'all' %}selected{% endif %}>All Orders</option>
                {% else %}
                    <option value="all" {% if current_filter == 'all' %}selected{% endif %}>All Shipped Orders</option>
                    <option value="shipped" {% if current_filter == 'shipped' %}selected{% endif %}>Shipped Only</option>
                    <option value="delivered" {% if current_filter == 'delivered' %}selected{% endif %}>Delivered Only</option>
                {% endif %}
            </select>
        </div>
    </div>

    <table class="table table-hover" id="ordersTable">
        <thead class="table-light">
            <tr>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Payment Method</th>
                <th>Date Ordered</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
            <tr>
                <td><a href="{% url 'orders' order.id %}" class="text-primary">{{ order.id }}</a></td>
                <td>{{ order.full_name }}</td>
                <td>ZMK {{ order.amount_paid|floatformat:2|intcomma }}</td>
                <td>
                    <span class="badge {% if order.status == 'paid' %}bg-success
                                        {% elif order.status == 'processing' %}bg-warning
                                        {% elif order.status == 'cancelled' %}bg-danger{% endif %}">
                        {{ order.get_status_display }}
                    </span>
                </td>
                <td>{{ order.get_payment_method_display|default:"Not specified" }}</td>
                <td>{{ order.date_ordered|date:"Y-m-d H:i" }}</td>
                <td>
                    {% if order.status != 'cancelled' %}
                        <div class="btn-group">
                            {# ðŸ’¡ FIX 1: Set the form action to the update_order_status view and pass the pk #}
                            <form method="POST" action="{% url 'update_order_status' pk=order.id %}" class="d-inline me-2">
                                {% csrf_token %}
                                {# Removed: <input type="hidden" name="num" value="{{ order.id }}"> as pk is in URL #}
                                <input type="hidden" name="action" value="shipped">
                                <button type="submit" class="btn btn-success btn-sm">
                                    <i class="bi bi-truck"></i> Ship
                                </button>
                            </form>
                            <button type="button" class="btn btn-danger btn-sm" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#cancelModal{{ order.id }}">
                                <i class="bi bi-x-circle"></i> Cancel
                            </button>
                        </div>
                    {% else %}
                        <span class="text-muted">
                            <i class="bi bi-info-circle"></i> 
                            Cancelled: {{ order.cancellation_notes|truncatechars:30 }}
                        </span>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" class="text-center py-4">
                    <div class="text-muted">
                        <i class="bi bi-inbox h4"></i>
                        <p>No orders found</p>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% for order in orders %}
        <div class="modal fade" id="cancelModal{{ order.id }}" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    {# ðŸ’¡ FIX 2: Set the form action to the update_order_status view and pass the pk #}
                    <form method="POST" action="{% url 'update_order_status' pk=order.id %}">
                        {% csrf_token %}
                        <div class="modal-header">
                            <h5 class="modal-title">Cancel Order #{{ order.id }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            {# Removed: <input type="hidden" name="num" value="{{ order.id }}"> as pk is in URL #}
                            <input type="hidden" name="action" value="cancel">
                            <div class="mb-3">
                                <label for="reason{{ order.id }}" class="form-label">Cancellation Reason</label>
                                <textarea class="form-control" 
                                          id="reason{{ order.id }}" 
                                          name="reason" 
                                          rows="3" 
                                          required 
                                          placeholder="Enter reason for cancellation"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-danger">
                                <i class="bi bi-x-circle"></i> Confirm Cancellation
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    {% endfor %}

    {# Add JavaScript for search and filter functionality #}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('orderSearch');
        const statusFilter = document.getElementById('statusFilter');
        const table = document.getElementById('ordersTable');
        const rows = table.getElementsByTagName('tr');

        function filterTable() {
            const searchText = searchInput.value.toLowerCase();
            const statusValue = statusFilter.value.toLowerCase();

            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const text = row.textContent.toLowerCase();
                // Find the badge status text (e.g., "Paid", "Processing", "Cancelled")
                const statusElement = row.querySelector('.badge');
                if (!statusElement) continue; 
                
                const status = statusElement.textContent.trim().toLowerCase();
                
                const matchesSearch = text.includes(searchText);
                // Matches status if the filter is 'all' or if the status contains the filter value
                const matchesStatus = statusValue === 'all' || status.includes(statusValue);

                row.style.display = matchesSearch && matchesStatus ? '' : 'none';
            }
        }
        
        // Note: The search and filter elements need IDs 'orderSearch' and 'statusFilter' 
        // in your HTML for this JS to work. I left the select element with an onchange handler,
        // which might conflict with this JS if you try to use both methods.
        // I recommend sticking to the pure HTML/Django form method for filtering
        // unless you plan to fully implement the JS logic.
    });
    </script>
</div>
{% endblock %}