{% extends 'base.html' %}
{% load humanize payment_extras %}

{% block content %}
<div class="container my-5">
    <h2 class="mb-4">Order #{{ order.id }} Details</h2>
    <hr>

    <div class="row g-4">
        
        {# --- LEFT COLUMN: Customer & Order Info --- #}
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-person-circle me-2"></i>Customer & Order Info
                </div>
                <div class="card-body">
                    <p><strong>Customer:</strong> {{ order.full_name }}</p>
                    <p><strong>Email:</strong> {{ order.email }}</p>
                    <strong>Phone: {{ order.phone_number }}</strong><br>
                    <p><strong>Shipping Address:</strong><br>
                        <span class="text-muted" style="white-space: pre-wrap;">{{ order.shipping_address }}</span>
                    </p>
                    <p>
                        <strong>Order Status:</strong>
                        <span class="badge bg-info ms-2">{{ order.get_status_display }}</span>
                    </p>
                    <p><strong>Date Ordered:</strong> {{ order.date_ordered|date:"Y-m-d H:i" }}</p>
                    {% if order.date_shipped %}
                        <p><strong>Date Shipped:</strong> {{ order.date_shipped|date:"Y-m-d H:i" }}</p>
                    {% endif %}
                    {# Display cancellation reason if cancelled #}
                    {% if order.status == 'cancelled' and order.cancellation_notes %}
                        <p class="text-danger mt-3"><strong>Cancellation Reason:</strong> {{ order.cancellation_notes }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        {# --- RIGHT COLUMN: Your Products and Calculations --- #}
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <i class="bi bi-box-seam me-2"></i>Your Products in this Order
                </div>
                <div class="card-body">
                    
                    {# Product List #}
                    <ul class="list-group list-group-flush mb-4">
                        {% for item in items %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ item.product.name }}</strong> 
                                    <small class="text-muted d-block">@ ZMK {{ item.price|floatformat:2|intcomma }}</small>
                                </div>
                                <span class="badge bg-secondary rounded-pill">x {{ item.quantity }}</span>
                            </li>
                        {% endfor %}
                    </ul>
                    
                    <hr>
                    
                    {# Calculations Display #}
                    <dl class="row mb-0">
                        <dt class="col-8 text-end text-muted">Your Subtotal:</dt>
                        <dd class="col-4 text-end text-muted">ZMK {{ seller_subtotal|floatformat:2|intcomma }}</dd>

                        <dt class="col-8 text-end text-danger">Commission ({{ items.first.commission_rate|multiply:100|floatformat:0 }}%):</dt>
                        <dd class="col-4 text-end text-danger">ZMK {{ total_commission|floatformat:2|intcomma }}</dd>

                        <dt class="col-8 text-end h5">Your Net Earnings:</dt>
                        <dd class="col-4 text-end h5 text-success">ZMK {{ seller_net_earnings|floatformat:2|intcomma }}</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mt-4 text-center">
    <h4 class="mb-3">Update Order Status</h4>
    <div class="card p-3 d-inline-block">
        {% if order.status != 'delivered' and order.status != 'cancelled' %}
            
            {# Status Button Logic #}
            {% if order.status == 'paid' %}
                {% with next_action='processing' next_label='Process' btn_class='btn-warning' %}
                    {# ADDED action attribute here #}
                    <form method="POST" action="{% url 'update_order_status' pk=order.id %}" class="d-inline-block me-2">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="{{ next_action }}">
                        <button type="submit" class="btn {{ btn_class }}"><i class="bi bi-arrow-repeat"></i> {{ next_label }} Order</button> 
                    </form>
                {% endwith %}
            
            {% elif order.status == 'processing' %}
                {% with next_action='shipped' next_label='Ship' btn_class='btn-success' %}
                    {# ADDED action attribute here #}
                    <form method="POST" action="{% url 'update_order_status' pk=order.id %}" class="d-inline-block me-2">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="{{ next_action }}">
                        <button type="submit" class="btn {{ btn_class }}"><i class="bi bi-truck"></i> {{ next_label }} Order</button> 
                    </form>
                {% endwith %}
            
            {% elif order.status == 'shipped' %}
                {% with next_action='delivered' next_label='Mark Delivered' btn_class='btn-primary' %}
                    {# ADDED action attribute here #}
                    <form method="POST" action="{% url 'update_order_status' pk=order.id %}" class="d-inline-block me-2">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="{{ next_action }}">
                        <button type="submit" class="btn {{ btn_class }}"><i class="bi bi-check2-circle"></i> {{ next_label }}</button> 
                    </form>
                {% endwith %}
            
            {% endif %}
            
            {# ðŸ’¡ CANCEL BUTTON: Triggers the modal #}
            <button type="button" class="btn btn-danger" 
                data-bs-toggle="modal" 
                data-bs-target="#cancelModal">
                <i class="bi bi-x-circle me-1"></i> Cancel Order
            </button>
        
        {% else %}
            <p class="text-muted">No further actions available for this order status ({{ order.get_status_display }}).</p>
        {% endif %}
    </div>
</div>
</div>

{# -------------------------------------------------------------------------------- #}
{# ðŸ’¡ MODAL STRUCTURE: Must be outside the main structure but still inside {% block content %} #}
<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            {# ðŸ’¡ THE FIX IS HERE: Set the form action to the correct URL #}
            <form method="POST" action="{% url 'update_order_status' pk=order.id %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="cancelModalLabel">Cancel Order #{{ order.id }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-danger">You are about to **permanently cancel** this order. A reason is required for internal records and customer communication.</p>
                    
                    <input type="hidden" name="action" value="cancel">
                    <div class="mb-3">
                        <label for="cancellationReason" class="form-label">Cancellation Reason</label>
                        <textarea class="form-control" 
                                  id="cancellationReason" 
                                  name="reason" 
                                  rows="3" 
                                  required 
                                  placeholder="Enter reason for cancellation (e.g., product out of stock, shipping delay issue)"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-x-circle"></i> Confirm Cancellation
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{# -------------------------------------------------------------------------------- #}

{% endblock %}